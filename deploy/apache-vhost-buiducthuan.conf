# Apache VirtualHost configuration for buiducthuan.pro
# Adjust paths to your aaPanel site root and cert paths as needed.

<VirtualHost *:80>
    ServerName buiducthuan.pro
    ServerAlias www.buiducthuan.pro

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R=301,L]
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName buiducthuan.pro
    ServerAlias www.buiducthuan.pro

    # Document root - frontend build output (dist)
    DocumentRoot /www/wwwroot/buiducthuan.pro/dist

    <Directory /www/wwwroot/buiducthuan.pro/dist>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # SSL certs (aaPanel/Let's Encrypt: adjust to actual paths)
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/buiducthuan.pro/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/buiducthuan.pro/privkey.pem

    # SPA fallback (also keep .htaccess in dist)
    # Apache VirtualHost configuration for buiducthuan.pro
    # This file was updated to include reverse-proxy rules for /api

    <VirtualHost *:80>
        ServerAdmin webmaster@example.com
        DocumentRoot "/www/wwwroot/buiducthuan.pro"
        ServerName 717c9778.buiducthuan.pro
        ServerAlias buiducthuan.pro
        ErrorLog "/www/wwwlogs/buiducthuan.pro-error_log"
        CustomLog "/www/wwwlogs/buiducthuan.pro-access_log" combined

        <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
           Order allow,deny
           Deny from all
        </Files>

        <FilesMatch \.php$>
            SetHandler "proxy:unix:/tmp/php-cgi-00.sock|fcgi://localhost"
        </FilesMatch>

        <Directory "/www/wwwroot/buiducthuan.pro">
            SetOutputFilter DEFLATE
            Options FollowSymLinks
            AllowOverride All
            Require all granted
            DirectoryIndex index.php index.html index.htm default.php default.html default.htm
        </Directory>
    </VirtualHost>

    <VirtualHost *:443>
        ServerAdmin webmaster@example.com
        DocumentRoot "/www/wwwroot/buiducthuan.pro/"
        ServerName SSL.buiducthuan.pro
        ServerAlias buiducthuan.pro
        ErrorLog "/www/wwwlogs/buiducthuan.pro-error_log"
        CustomLog "/www/wwwlogs/buiducthuan.pro-access_log" combined

        SSLEngine On
        SSLCertificateFile /www/server/panel/vhost/cert/buiducthuan.pro/fullchain.pem
        SSLCertificateKeyFile /www/server/panel/vhost/cert/buiducthuan.pro/privkey.pem
        SSLCipherSuite EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5:ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
        SSLProtocol All -SSLv2 -SSLv3 -TLSv1
        SSLHonorCipherOrder On

        # Reverse proxy API requests to Node backend
        ProxyPreserveHost On
        ProxyRequests Off
        ProxyPass        /api http://127.0.0.1:5000/api
        ProxyPassReverse /api http://127.0.0.1:5000/api
        RequestHeader set X-Forwarded-Proto "https"

        <FilesMatch \.php$>
            SetHandler "proxy:unix:/tmp/php-cgi-00.sock|fcgi://localhost"
        </FilesMatch>

        <Files ~ (\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md)$>
           Order allow,deny
           Deny from all
        </Files>

        <Directory "/www/wwwroot/buiducthuan.pro/">
            SetOutputFilter DEFLATE
            Options FollowSymLinks
            AllowOverride All
            Require all granted
            DirectoryIndex index.php index.html index.htm default.php default.html default.htm
        </Directory>
    </VirtualHost>
